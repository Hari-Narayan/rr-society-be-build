"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.notifyNewComment=exports.registerGrievanceHandlers=void 0;const io_1=require("../socket/io"),member_1=require("../models/member"),grievance_1=__importDefault(require("../models/grievance")),registerGrievanceHandlers=(e,o)=>{o.on("grievance:join",((e,r)=>{if(!e)return void(r&&r({error:"Invalid Grievance ID"}));const t=`grievance:${e}`;o.join(t),console.info(`[Socket] ${o.id} joined room: ${t}`),r&&r({status:"success",room:t})})),o.on("grievance:leave",(e=>{if(!e)return;const r=`grievance:${e}`;o.leave(r),console.info(`[Socket] ${o.id} left room: ${r}`)})),o.on("grievance:send_message",(async o=>{if(console.info(`[Socket] Message received for ${o.grievanceId}: ${o.message}`),o.grievanceId&&o.message&&o.userId)try{const r=await grievance_1.default.findById(o.grievanceId);if(!r)return;r.comments||(r.comments=[]),r.comments.push({message:o.message,commentedBy:o.userId}),await r.save(),await r.populate(member_1.populateCommentedByOptions);const t=r.comments[r.comments.length-1];e.to(`grievance:${o.grievanceId}`).emit("grievance:comment_added",t)}catch(e){console.error("[Socket] Error saving comment:",e)}}))};exports.registerGrievanceHandlers=registerGrievanceHandlers;const notifyNewComment=(e,o)=>{try{(0,io_1.getIO)().to(`grievance:${e}`).emit("grievance:comment_added",o)}catch(e){console.error("[Socket] Failed to emit new comment event:",e)}};exports.notifyNewComment=notifyNewComment;