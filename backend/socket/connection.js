"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.initSocket=void 0;const socket_io_1=require("socket.io"),io_1=require("../socket/io"),authHelper_1=require("../helpers/authHelper"),grievanceHandler_1=require("../socket/grievanceHandler"),initSocket=e=>{const o=new socket_io_1.Server(e,{path:"/socket-io",transports:["websocket","polling"],cors:{origin:"*",methods:["GET","POST"]}});return(0,io_1.setIO)(o),o.use((async(e,o)=>{var t,i,n,r,s;try{const c=(null===(t=e.handshake.auth)||void 0===t?void 0:t.token)||(null===(n=null===(i=e.handshake.headers)||void 0===i?void 0:i.authorization)||void 0===n?void 0:n.split(" ")[1]),a=(null===(r=e.handshake.headers)||void 0===r?void 0:r.society)||(null===(s=e.handshake.auth)||void 0===s?void 0:s.societyId);if(!c)return o(new Error("Authentication error: Token missing"));const d=await(0,authHelper_1.verifyTokenAndGetUser)(c,a);e.data.user=d,o()}catch(e){o(new Error("Authentication error: Invalid token"))}})),o.on("connection",(e=>{console.info(`[Socket] Client connected: ${e.id}`),(0,grievanceHandler_1.registerGrievanceHandlers)(o,e),e.on("disconnect",(()=>{console.info(`[Socket] Client disconnected: ${e.id}`)}))})),o};exports.initSocket=initSocket;