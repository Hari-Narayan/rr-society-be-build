"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,i)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var e=function(t){return e=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},e(t)};return function(t){if(t&&t.__esModule)return t;var n={};if(null!=t)for(var o=e(t),i=0;i<o.length;i++)"default"!==o[i]&&__createBinding(n,t,o[i]);return __setModuleDefault(n,t),n}}(),__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.details=exports.massDelete=exports.remove=exports.getResults=exports.vote=exports.addCandidate=exports.softDelete=exports.update=exports.create=exports.list=void 0;const paginate_1=__importDefault(require("../utils/paginate")),commonHelper_1=__importDefault(require("../helpers/commonHelper")),common_1=require("../lang/en/common"),society_1=require("../models/society"),election_1=__importStar(require("../models/election")),member_1=__importStar(require("../models/member")),election_2=require("../lang/en/election"),list=async(e,t)=>{var n,o;try{let i=election_2.ELECTION_FOUND;const d=commonHelper_1.default.createSearchFilter(e,["title","description","designation"],{society:null===(o=null===(n=e.user)||void 0===n?void 0:n.society)||void 0===o?void 0:o.id}),a=commonHelper_1.default.createPageOptions(e),r=await(0,paginate_1.default)(election_1.default,d,a.page,a.limit,[society_1.populateSocietyOptions,member_1.populateCreatedByOptions,member_1.populateCandidateOptions],a.sort);0===r.totalDocs&&(i=election_2.ELECTION_NOT_FOUND),t.sendSuccess(200,i,r)}catch(e){t.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.list=list;const create=async(e,t)=>{try{const n=[];e.body.candidates&&Array.isArray(e.body.candidates)&&n.push(...e.body.candidates.map((e=>({count:0,candidate:e}))));const o=await new election_1.default({...e.body,candidates:n,createdBy:e.user.id,society:e.user.society.id,electionDate:new Date(e.body.electionDate),nominationDeadline:new Date(e.body.nominationDeadline)}).save();t.sendSuccess(200,election_2.ELECTION_CREATED,o)}catch(e){console.error(e),t.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.create=create;const update=async(e,t)=>{try{let n=await election_1.default.findOne({deletedAt:null,_id:e.params.id});if(!n)return void t.sendError(400,election_2.ELECTION_NOT_FOUND);if(n.status!==election_1.ElectionStatus.Scheduled)return void t.sendError(400,election_2.ELECTION_NOT_UPDATED);let o=await election_1.default.findOneAndUpdate({_id:e.params.id,deletedAt:null},{$set:e.body},{new:!0});t.sendSuccess(200,election_2.ELECTION_UPDATED,o)}catch(e){t.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.update=update;const softDelete=async(e,t)=>{try{let n=await election_1.default.findOneAndUpdate({_id:e.params.id,deletedAt:null},{$set:{deletedAt:new Date}},{new:!0});if(!n)return void t.sendError(400,election_2.ELECTION_NOT_FOUND);t.sendSuccess(200,election_2.ELECTION_DELETED,n)}catch(e){t.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.softDelete=softDelete;const addCandidate=async(e,t)=>{const{candidateId:n}=e.body;try{if(!await member_1.default.findById(n))return void t.sendError(400,election_2.CANDIDATE_NOT_FOUND);let o=await election_1.default.findOneAndUpdate({deletedAt:null,_id:e.params.id,society:e.user.society.id},{$addToSet:{candidates:{count:0,candidate:n}}},{new:!0}).populate(member_1.populateCandidateOptions);if(!o)return void t.sendError(400,election_2.ELECTION_NOT_FOUND);t.sendSuccess(200,election_2.CANDIDATE_ADDED,o)}catch(e){t.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.addCandidate=addCandidate;const vote=async(e,t)=>{const n=e.params.id;try{const o=e.user,i=o.id,d=o.society.id;if(await election_1.default.findOne({_id:n,voters:i,society:d}))return void t.sendError(400,"You have already voted in this election");let a=await election_1.default.findOne({deletedAt:null,_id:n,society:d,status:{$in:[election_1.ElectionStatus.Active,election_1.ElectionStatus.InProgress]}});if(!a)return void t.sendError(400,election_2.ELECTION_NOT_FOUND);if(!a.candidates.some((t=>t.candidate.toString()===e.body.candidateId)))return void t.sendError(400,"Invalid candidate");const r=await election_1.default.findOneAndUpdate({_id:n,"candidates.candidate":e.body.candidateId},{$addToSet:{voters:i},$inc:{"candidates.$.count":1}},{new:!0}).populate([member_1.populateCandidateOptions,member_1.populateCreatedByOptions]);if(r)a=r;else{a=await election_1.default.findOneAndUpdate({_id:n},{$addToSet:{voters:i},$push:{candidates:{candidate:e.body.candidateId,count:1}}},{new:!0}).populate([member_1.populateCandidateOptions,member_1.populateCreatedByOptions])}t.sendSuccess(200,election_2.VOTE_RECORDED,a)}catch(e){t.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.vote=vote;const getResults=async(e,t)=>{try{let n=await election_1.default.findOne({deletedAt:null,_id:e.params.id,society:e.user.society.id}).populate([member_1.populateCandidateOptions,member_1.populateCreatedByOptions]);if(!n)return void t.sendError(400,election_2.ELECTION_NOT_FOUND);const o=n.candidates.filter((e=>e.candidate)).map((e=>({candidate:e.candidate,voteCount:e.count})));o.sort(((e,t)=>t.voteCount-e.voteCount)),t.sendSuccess(200,election_2.ELECTION_RESULTS,{election:{_id:n._id,title:n.title,status:n.status,description:n.description,designation:n.designation,electionDate:n.electionDate},results:o,totalVotes:n.voters.length})}catch(e){t.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.getResults=getResults;const remove=async(e,t)=>{try{if(!await election_1.default.findOneAndDelete({_id:e.params.id}))return void t.sendError(400,election_2.ELECTION_NOT_FOUND);t.sendSuccess(200,election_2.ELECTION_DELETED)}catch(e){t.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.remove=remove;const massDelete=async(e,t)=>{try{const n=e.body.ids||[];if(0===(await election_1.default.deleteMany({_id:{$in:n}})).deletedCount)return void t.sendError(400,election_2.ELECTION_NOT_FOUND);t.sendSuccess(200,election_2.ELECTION_DELETED)}catch(e){t.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.massDelete=massDelete;const details=async(e,t)=>{try{let n=await election_1.default.findOne({deletedAt:null,_id:e.params.id,society:e.user.society.id}).populate([society_1.populateSocietyOptions,member_1.populateCreatedByOptions,member_1.populateCandidateOptions]);if(!n)return void t.sendError(400,election_2.ELECTION_NOT_FOUND);const o=n.toObject();delete o.voters,t.sendSuccess(200,election_2.ELECTION_FOUND,o)}catch(e){t.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.details=details;