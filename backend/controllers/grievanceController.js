"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var o=Object.getOwnPropertyDescriptor(t,r);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,o)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var e=function(t){return e=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},e(t)};return function(t){if(t&&t.__esModule)return t;var r={};if(null!=t)for(var n=e(t),o=0;o<n.length;o++)"default"!==n[o]&&__createBinding(r,t,n[o]);return __setModuleDefault(r,t),r}}(),__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.details=exports.massDelete=exports.remove=exports.addComment=exports.softDelete=exports.update=exports.create=exports.list=void 0;const paginate_1=__importDefault(require("../utils/paginate")),commonHelper_1=__importDefault(require("../helpers/commonHelper")),grievance_1=__importStar(require("../models/grievance")),common_1=require("../lang/en/common"),society_1=require("../models/society"),member_1=require("../models/member"),grievance_2=require("../lang/en/grievance"),list=async(e,t)=>{try{let r=grievance_2.GRIEVANCE_FOUND;const n=commonHelper_1.default.createSearchFilter(e,["title","description"],{society:e.user.society.id}),o=commonHelper_1.default.createPageOptions(e),a=await(0,paginate_1.default)(grievance_1.default,n,o.page,o.limit,[society_1.populateSocietyOptions,member_1.populateCreatedByOptions,member_1.populateCommentedByOptions],o.sort);0===a.totalDocs&&(r=grievance_2.GRIEVANCE_NOT_FOUND),t.sendSuccess(200,r,a)}catch(e){t.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.list=list;const create=async(e,t)=>{try{const r=await new grievance_1.default({...e.body,createdBy:e.user.id,society:e.user.society.id}).save();t.sendSuccess(200,grievance_2.GRIEVANCE_CREATED,r)}catch(e){t.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.create=create;const update=async(e,t)=>{try{let r=await grievance_1.default.findOne({deletedAt:null,_id:e.params.id});if(!r)return void t.sendError(400,grievance_2.GRIEVANCE_NOT_FOUND);if(r.status!==grievance_1.Status.Open)return void t.sendError(400,grievance_2.GRIEVANCE_NOT_UPDATED);let n=await grievance_1.default.findOneAndUpdate({_id:e.params.id,deletedAt:null},{$set:e.body},{new:!0});t.sendSuccess(200,grievance_2.GRIEVANCE_UPDATED,n)}catch(e){t.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.update=update;const softDelete=async(e,t)=>{try{let r=await grievance_1.default.findOneAndUpdate({_id:e.params.id,deletedAt:null},{$set:{deletedAt:new Date}},{new:!0});if(!r)return void t.sendError(400,grievance_2.GRIEVANCE_NOT_FOUND);t.sendSuccess(200,grievance_2.GRIEVANCE_DELETED,r)}catch(e){t.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.softDelete=softDelete;const addComment=async(e,t)=>{const{id:r,society:n}=e.user;try{let o=await grievance_1.default.findOneAndUpdate({deletedAt:null,_id:e.params.id,society:n.id},{$push:{comments:{message:e.body.message,commentedBy:r}}},{new:!0}).populate(member_1.populateCommentedByOptions);if(!o)return void t.sendError(400,grievance_2.GRIEVANCE_NOT_FOUND);t.sendSuccess(200,grievance_2.GRIEVANCE_COMMENT_ADDED,o)}catch(e){console.error(e),t.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.addComment=addComment;const remove=async(e,t)=>{try{if(!await grievance_1.default.findOneAndDelete({_id:e.params.id}))return void t.sendError(400,grievance_2.GRIEVANCE_NOT_FOUND);t.sendSuccess(200,grievance_2.GRIEVANCE_DELETED)}catch(e){t.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.remove=remove;const massDelete=async(e,t)=>{try{const r=e.body.ids||[];if(0===(await grievance_1.default.deleteMany({_id:{$in:r}})).deletedCount)return void t.sendError(400,grievance_2.GRIEVANCE_NOT_FOUND);t.sendSuccess(200,grievance_2.GRIEVANCE_DELETED)}catch(e){t.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.massDelete=massDelete;const details=async(e,t)=>{try{let r=await grievance_1.default.findOne({deletedAt:null,_id:e.params.id,society:e.user.society.id}).populate([society_1.populateSocietyOptions,member_1.populateCreatedByOptions,member_1.populateCommentedByOptions]);if(!r)return void t.sendError(400,grievance_2.GRIEVANCE_NOT_FOUND);t.sendSuccess(200,grievance_2.GRIEVANCE_FOUND,r)}catch(e){t.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.details=details;