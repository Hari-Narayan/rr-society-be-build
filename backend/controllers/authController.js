"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var a=Object.getOwnPropertyDescriptor(t,r);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,a)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var e=function(t){return e=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},e(t)};return function(t){if(t&&t.__esModule)return t;var r={};if(null!=t)for(var o=e(t),a=0;a<o.length;a++)"default"!==o[a]&&__createBinding(r,t,o[a]);return __setModuleDefault(r,t),r}}(),__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getLoginHistory=exports.resetPassword=exports.forgotPassword=exports.register=exports.login=void 0;const bcryptjs_1=__importDefault(require("bcryptjs")),configs_1=__importDefault(require("../configs")),paginate_1=__importDefault(require("../utils/paginate")),mailHelper_1=__importDefault(require("../helpers/mailHelper")),member_1=require("../lang/en/member"),commonHelper_1=__importDefault(require("../helpers/commonHelper")),resetPassword_1=__importDefault(require("../models/resetPassword")),common_1=require("../lang/en/common"),member_2=__importStar(require("../models/member")),role_1=__importStar(require("../models/role")),loginHistory_1=__importDefault(require("../models/loginHistory")),society_1=require("../models/society"),auth_1=require("../lang/en/auth"),login=async(e,t)=>{try{const{email:r,password:o,loginType:a}=e.body;if("G"===a)return t.sendError(400,auth_1.INCORRECT_LOGIN_TYPE);if("M"===a){const e=await member_2.default.findOne({email:r,deletedAt:null}).populate([role_1.populateRolesOptions,society_1.populateSocietiesOptions]);if(!e)return t.sendError(400,member_1.MEMBER_NOT_FOUND);if(!bcryptjs_1.default.compareSync(o,e.password))return t.sendError(400,auth_1.INCORRECT_PASSWORD);let a=[],s=[];const n=e.toJSON();e.roles.length&&e.roles.forEach((e=>{a=[...a,e.name.toUpperCase()],s=[...s,...e.permissions]}));const i=commonHelper_1.default.generateToken(e.email);t.sendSuccess(200,auth_1.LOGIN_SUCCESS,{...n,token:i,roles:a,permissions:[...new Set(s)]})}}catch(e){t.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.login=login;const register=async(e,t)=>{try{let r=[],o=await member_2.default.findOne({email:e.body.email});if(o)return void t.sendError(400,auth_1.MEMBER_ALREADY_EXIST);const a=await role_1.default.find({name:{$in:configs_1.default.defaultRoles}}).select("_id name permissions");a.length>0&&(r=a.map((e=>e._id.toString()))),o=await new member_2.default({...e.body,roles:r}).save(),o=await o.populate(role_1.populateRolesOptions);const s=commonHelper_1.default.generateToken(o.email);t.sendSuccess(200,auth_1.REGISTER_SUCCESS,{...o.toJSON(),token:s})}catch(e){t.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.register=register;const forgotPassword=async(e,t)=>{try{const{email:r}=e.body;if(!await member_2.default.findOne({email:r}))return void t.sendError(404,member_1.MEMBER_NOT_FOUND);await resetPassword_1.default.findOneAndDelete({email:r});const o=await new resetPassword_1.default({email:r,token:commonHelper_1.default.randomString(60),expiredAt:(new Date).getTime()+36e5}).save();await mailHelper_1.default.mailer({to:r,subject:"Reset Password",html:`<a href="${configs_1.default.resetLink.replace("token",o.token)}" target="_blank">Click here to reset password</a>`}),t.sendSuccess(200,auth_1.RESET_LINK_SENT,o)}catch(e){t.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.forgotPassword=forgotPassword;const resetPassword=async(e,t)=>{try{const r=(new Date).getTime(),{token:o,newPassword:a}=e.body,s=await resetPassword_1.default.findOne({token:o});if(!s)return void t.sendError(404,member_1.MEMBER_NOT_FOUND);const{email:n,expiredAt:i}=s;if(r>i)return void t.sendError(400,auth_1.RESET_LINK_EXPIRED);await member_2.default.findOneAndUpdate({email:n},{$set:{password:a}},{new:!0}),await resetPassword_1.default.deleteOne({token:o}),t.sendSuccess(200,auth_1.PASSWORD_CHANGED)}catch(e){t.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.resetPassword=resetPassword;const getLoginHistory=async(e,t)=>{try{const r=commonHelper_1.default.createPageOptions(e),o=await(0,paginate_1.default)(loginHistory_1.default,{},r.page,r.limit,[member_2.populateMemberOptions,society_1.populateSocietyOptions],r.sort),a={page:o.page,limit:o.limit,totalDocs:o.totalDocs,totalPages:o.totalPages,hasPrevPage:o.hasPrevPage,hasNextPage:o.hasNextPage,docs:o.docs,pagingCounter:(o.page-1)*o.limit+1,prevPage:o.hasPrevPage?o.page-1:null,nextPage:o.hasNextPage?o.page+1:null};t.sendSuccess(200,"Login history retrieved successfully",a)}catch(e){t.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.getLoginHistory=getLoginHistory;