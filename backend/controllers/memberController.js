"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.list=exports.uploadImage=void 0,exports.myProfile=myProfile,exports.updatePassword=updatePassword;const bcryptjs_1=require("bcryptjs"),paginate_1=__importDefault(require("../utils/paginate")),commonHelper_1=__importDefault(require("../helpers/commonHelper")),modelHelper_1=require("../helpers/modelHelper"),common_1=require("../lang/en/common"),member_1=__importDefault(require("../models/member")),auth_1=require("../lang/en/auth"),fileUploadOnCloudHelper_1=__importDefault(require("../helpers/fileUploadOnCloudHelper")),member_2=require("../lang/en/member");async function myProfile(e,r){try{const a=e.user;r.sendSuccess(200,member_2.MEMBER_FOUND,a)}catch(e){r.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}}async function updatePassword(e,r){try{const{_id:a,password:t}=e.user,{oldPassword:o,newPassword:l}=e.body;if(!await(0,bcryptjs_1.compare)(o,t))return void r.sendError(400,auth_1.INCORRECT_PASSWORD);const s=(0,modelHelper_1.encryptPassword)(l);await member_1.default.updateOne({_id:a},{$set:{password:s}}),r.sendSuccess(200,auth_1.PASSWORD_CHANGED)}catch(e){r.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}}const uploadImage=async(e,r)=>{try{await fileUploadOnCloudHelper_1.default.uploadSingleFile(e,"profileImage","members");const{profileImage:a=null}=e.body;if(!a)return r.sendError(400,"No file uploaded.");e.user.profileImage&&fileUploadOnCloudHelper_1.default.removeSingleFile(commonHelper_1.default.extractFileIdFromUrl(e.user.profileImage,"members"));const t=await member_1.default.findOneAndUpdate({_id:e.user.id},{$set:{profileImage:a}},{new:!0});r.sendSuccess(200,member_2.IMAGE_UPLOADED,t)}catch(e){r.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.uploadImage=uploadImage;const list=async(e,r)=>{try{let a=member_2.MEMBER_FOUND;const t=commonHelper_1.default.createSearchFilter(e,["fullName","email"]),o=commonHelper_1.default.createPageOptions(e),l=await(0,paginate_1.default)(member_1.default,t,o.page,o.limit,[],o.sort),s={docs:l.docs,totalDocs:l.totalDocs,limit:l.limit,totalPages:l.totalPages,page:l.page,hasPrevPage:l.hasPrevPage,hasNextPage:l.hasNextPage,pagingCounter:l.hasPrevPage?(l.page-1)*l.limit+1:1,prevPage:l.hasPrevPage?l.page-1:null,nextPage:l.hasNextPage?l.page+1:null};0===s.totalDocs&&(a=member_2.MEMBER_NOT_FOUND),r.sendSuccess(200,a,s)}catch(e){r.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.list=list;