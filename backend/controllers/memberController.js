"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.list=exports.uploadImage=void 0,exports.myProfile=myProfile,exports.updatePassword=updatePassword;const bcryptjs_1=require("bcryptjs"),commonHelper_1=__importDefault(require("../helpers/commonHelper")),modelHelper_1=require("../helpers/modelHelper"),common_1=require("../lang/en/common"),member_1=__importDefault(require("../models/member")),auth_1=require("../lang/en/auth"),fileUploadOnCloudHelper_1=__importDefault(require("../helpers/fileUploadOnCloudHelper")),member_2=require("../lang/en/member");async function myProfile(e,r){try{const o=e.user;r.sendSuccess(200,member_2.MEMBER_FOUND,o)}catch(e){r.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}}async function updatePassword(e,r){try{const{_id:o,password:t}=e.user,{oldPassword:l,newPassword:a}=e.body;if(!await(0,bcryptjs_1.compare)(l,t))return void r.sendError(400,auth_1.INCORRECT_PASSWORD);const s=(0,modelHelper_1.encryptPassword)(a);await member_1.default.updateOne({_id:o},{$set:{password:s}}),r.sendSuccess(200,auth_1.PASSWORD_CHANGED)}catch(e){r.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}}const uploadImage=async(e,r)=>{try{await fileUploadOnCloudHelper_1.default.uploadSingleFile(e,"profileImage","members");const{profileImage:o=null}=e.body;if(!o)return r.sendError(400,"No file uploaded.");e.user.profileImage&&fileUploadOnCloudHelper_1.default.removeSingleFile(commonHelper_1.default.extractFileIdFromUrl(e.user.profileImage,"members"));const t=await member_1.default.findOneAndUpdate({_id:e.user.id},{$set:{profileImage:o}},{new:!0});r.sendSuccess(200,member_2.IMAGE_UPLOADED,t)}catch(e){r.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.uploadImage=uploadImage;const list=async(e,r)=>{try{let o=member_2.MEMBER_FOUND;const t=await member_1.default.paginate(commonHelper_1.default.createSearchFilter(e,["fullName","email"]),commonHelper_1.default.createPageOptions(e,null));0===t.totalDocs&&(o=member_2.MEMBER_NOT_FOUND),r.sendSuccess(200,o,t)}catch(e){r.sendError(500,common_1.SOMETHING_WENT_WRONG,e)}};exports.list=list;