"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const path_1=require("path"),fs_1=require("fs"),console_log_colors_1=require("console-log-colors"),jsonwebtoken_1=__importDefault(require("jsonwebtoken")),configs_1=__importDefault(require("../configs"));class CommonHelper{static extractRoutePaths(e,t){try{const o=(0,path_1.resolve)(e),r=(0,fs_1.readFileSync)(o,"utf-8"),s=new RegExp(/rootRouter\.use\(\s*["'`]([^"'`]+)["'`]/g),a=Array.from(r.matchAll(s));console.info("\n========== Route List Start ==========\n"),a.forEach((e=>{const o=`${t}${e[1]}/`;console.info(console_log_colors_1.color.blue(o))})),console.info("\n=========== Route List End ===========\n")}catch(e){console.error(`Error reading or parsing file: ${e.message}`)}}static randomString(e=40){let t="";const o="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";for(let r=e;r>0;--r)t+=o[Math.floor(Math.random()*o.length)];return t}static serializeRouterStack(e,t="",o=""){const r={layers:[],prefix:o||"/"};return e?(e.forEach((e=>{var s,a;try{const n={};if(e.route){n.type="route";const r=Object.keys(e.route.methods).map((e=>e.toUpperCase()));n.methods=r.join(", "),n.fullPath=`${t}${o}${"/"===e.route.path&&o?"":e.route.path}`,n.pathWithoutPrefix=`${o}${"/"===e.route.path&&o?"":e.route.path}`}else if("router"===e.name&&(null===(s=e.handle)||void 0===s?void 0:s.stack)){const o=((null===(a=e.regexp)||void 0===a?void 0:a.toString())||"").match(/\/(\w+)/),r=(null==o?void 0:o[1])?`/${o[1]}`:"";n.type="router",n.prefix=r,n.stack=this.serializeRouterStack(e.handle.stack,t,r).layers}else e.handle?(n.type="middleware",n.middleware=e.handle.name||"anonymous"):n.type="unknown";r.layers.push(n)}catch(e){console.error(`Error processing layer: ${e.message}`)}})),r):(console.error("Error: Router stack is not available."),r)}static extractRoutes(e=[]){const t=[];return e.forEach((e=>{e.stack?e.stack.forEach((e=>{e.pathWithoutPrefix&&t.push({METHODS:e.methods,ROUTE:e.pathWithoutPrefix})})):e.pathWithoutPrefix&&t.push({METHODS:e.methods,ROUTE:e.pathWithoutPrefix})})),t}static createPageOptions(e,t=null){const{page:o,limit:r,sort:s=""}=e.query||{},a={sort:configs_1.default.pageOptions.sort,collation:configs_1.default.pageOptions.collation,page:isNaN(Number(o))?configs_1.default.pageOptions.page:Number(o),limit:Number(r)||configs_1.default.pageOptions.limit};if(t&&(a.populate=t),s){const e=s.split(":"),t=e[0],o="ASC"===e[1]?1:-1;a.sort={[t]:o}}return a}static createSearchFilter({query:e={}},t=[],o={}){const{searchText:r=""}=e;let s={...o,deletedAt:null};return""!==r.trim()&&t.length&&(s.$or=t.map((e=>({[e]:{$regex:r,$options:"i"}})))),s}static capitalizeFirstLetter(e){return e.replace(/\b\w/g,(e=>e.toUpperCase()))}}CommonHelper.generateToken=e=>{if(!configs_1.default.jwtSecret||!configs_1.default.expireTime)throw new Error("JWT configuration is missing");const t={expiresIn:configs_1.default.expireTime};return jsonwebtoken_1.default.sign({email:e},configs_1.default.jwtSecret,t)},CommonHelper.displayRoutes=(e,t)=>{try{const e=CommonHelper.serializeRouterStack(t.stack,configs_1.default.apiBaseUrl);console.table(CommonHelper.extractRoutes(e.layers))}catch(e){console.error(console_log_colors_1.color.red(`âŒ Error: ${e}`))}},CommonHelper.extractFileIdFromUrl=(e,t)=>{if(!e||"string"!=typeof e)return"";try{const o=e.split("/"),r=o[o.length-1];return`${configs_1.default.appName}/${t}/${r.replace(/\.[^/.]+$/,"")}`}catch(t){return console.error("Failed to extract file ID from URL:",e,t),""}},exports.default=CommonHelper;