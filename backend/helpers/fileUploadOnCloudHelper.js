"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const stream_1=require("stream"),uuid_1=require("uuid"),fs_1=require("fs"),cloudinary_1=require("cloudinary"),configs_1=__importDefault(require("../configs"));cloudinary_1.v2.config({api_key:configs_1.default.cloudinary.apiKey,api_secret:configs_1.default.cloudinary.apiSecret,cloud_name:configs_1.default.cloudinary.cloudName});class FileUploadHelper{static bufferToStream(e){const a=new stream_1.Readable;return a.push(e),a.push(null),a}static async uploadToCloudinary(e,a,t){const i={folder:t,public_id:a,resource_type:"auto"};if(e.tempFilePath&&(0,fs_1.existsSync)(e.tempFilePath))return await cloudinary_1.v2.uploader.upload(e.tempFilePath,i);if(e.data instanceof Buffer)return new Promise(((a,t)=>{const l=cloudinary_1.v2.uploader.upload_stream(i,((e,i)=>{e?t(e):a(i)}));this.bufferToStream(e.data).pipe(l)}));throw new Error("Invalid file: no data or tempFilePath")}static async uploadSingleFile(e,a,t){var i,l;if(!(null===(i=e.files)||void 0===i?void 0:i[a]))return;const r=(0,uuid_1.v4)(),o=e.files[a],s=await this.uploadToCloudinary(o,r,`${configs_1.default.appName}/${t}`);o.tempFilePath&&(0,fs_1.existsSync)(o.tempFilePath)&&(0,fs_1.unlinkSync)(o.tempFilePath),null!==(l=e.body)&&void 0!==l||(e.body={}),e.body[a]=`${s.display_name}.${s.format}`}static async uploadMultipleFiles(e,a="",t=""){var i;try{if(!e.files||!e.files[a])return;const l=e.files[a],r=[],o=Array.isArray(l)?l:[l];for(const e of o){const a=(0,uuid_1.v4)(),i=await this.uploadToCloudinary(e,a,`${configs_1.default.appName}/${t}`);e.tempFilePath&&(0,fs_1.existsSync)(e.tempFilePath)&&(0,fs_1.unlinkSync)(e.tempFilePath),r.push(`${i.display_name}.${i.format}`)}null!==(i=e.body)&&void 0!==i||(e.body={}),e.body[a]=r}catch(e){throw new Error(`Multiple upload failed: ${e.message}`)}}static async removeSingleFile(e){if(e)try{await cloudinary_1.v2.uploader.destroy(e)}catch(e){throw new Error(`Delete failed: ${e.message}`)}}static async removeMultipleFiles(e=[]){if(e.length)try{await cloudinary_1.v2.api.delete_resources(e)}catch(e){throw new Error(`Bulk delete failed: ${e.message}`)}}}exports.default=FileUploadHelper;