"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.verifyTokenAndGetUser=void 0;const jsonwebtoken_1=require("jsonwebtoken"),configs_1=__importDefault(require("../configs")),constant_1=require("../constant"),member_1=__importDefault(require("../models/member")),member_2=require("../lang/en/member"),role_1=require("../models/role"),loginHistory_1=__importDefault(require("../models/loginHistory")),society_1=require("../models/society"),verifyTokenAndGetUser=async(e,i)=>{const{email:o="",societyId:t}=(0,jsonwebtoken_1.verify)(e,configs_1.default.jwtSecret),s={email:o,deletedAt:null};i?s.societies=i:t&&(s.societies=t);const r=await member_1.default.findOne(s).populate([role_1.populateRolesOptions,society_1.populateSocietiesOptions]);if(!r)throw new Error(member_2.MEMBER_NOT_FOUND);let n=!1,l=[],a=[],m={roles:[],id:r.id,isAdmin:!1,permissions:[],email:r.email,fullName:r.fullName,societies:r.societies,profileImage:r.profileImage};i?m.society=r.societies.find((e=>e.id===i))||null:t&&(m.society=r.societies.find((e=>e.id===t))||null),r.roles.length&&(r.roles.forEach((e=>{l=[...l,e.name.toUpperCase()],a=[...a,...e.permissions]})),l.includes(constant_1.ADMIN)&&(n=!0)),m={...m,roles:l,isAdmin:n,permissions:[...new Set(a)]};const u=await loginHistory_1.default.findOne({token:e}).populate([society_1.populateSocietyOptions]);return u&&(m.society=u.society),m};exports.verifyTokenAndGetUser=verifyTokenAndGetUser;